<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mi Perfil - Banco de Horas</title>
<link rel="stylesheet" href="../css/styles.css">
<style>
.caja-centro {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    min-height: 60vh;
    padding: 30px;
    border-radius: 15px;
    margin: 20px auto;
    border: 3px solid #75b8ee;
    background: rgba(255,255,255,0.95);
    max-width: 500px;
}

.caja-centro h2 { text-align: center; margin-bottom: 20px; }

.perfil-item { margin-bottom: 15px; }
.perfil-item label { font-weight: bold; display: block; margin-bottom: 5px; }
.perfil-item input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ccc; }

.boton-accion { 
    background: linear-gradient(135deg,#599bd1 0%,#75b8ee 100%);
    color: white; border: none; padding: 10px 20px; border-radius: 8px;
    font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; 
}

.boton-accion:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.3); }
</style>
</head>
<body>
<header class="header-principal">
    <div class="contenedor-logo-header">
        <img src="../images/Logo_pascual.png" alt="Logo" class="logo-header">
    </div>
    <div class="titulo-header">
        <h1>Mi Perfil</h1>
    </div>
    <div class="usuario-info" id="usuario-info"></div>
</header>

<div class="contenedor-principal">
    <div class="caja-centro">
        <h2>Información de Usuario</h2>

        <div class="perfil-item">
            <label>Nombre</label>
            <input type="text" id="input-nombre" placeholder="Nombre completo">
        </div>

        <div class="perfil-item">
            <label>Correo</label>
            <input type="email" id="input-correo" placeholder="Correo electrónico">
        </div>

        <div class="perfil-item">
            <label>Documento</label>
            <input type="text" id="input-documento" disabled>
        </div>

        <div class="perfil-item">
            <label>Nueva Contraseña</label>
            <input type="password" id="input-password" placeholder="Dejar vacío si no cambia">
        </div>

        <button class="boton-accion" id="btn-guardar">Guardar Cambios</button>
        <button class="boton-accion" id="btn-cerrar-sesion">Cerrar Sesión</button>
        <p id="mensaje" style="margin-top:10px;color:red;"></p>
    </div>
</div>

<script>
function getToken() { return localStorage.getItem('token'); }

async function cargarPerfil() {
    const token = getToken();
    if (!token) return window.location.href='login.html';

    try {
        const res = await fetch('/api/auth/profile', { headers: { 'Authorization': token } });
        if(res.ok){
            const data = await res.json();
            document.getElementById('input-nombre').value = data.user.nombre || '';
            document.getElementById('input-correo').value = data.user.correo || '';
            document.getElementById('input-documento').value = data.user.documento || '';
        } else {
            localStorage.removeItem('token');
            window.location.href='login.html';
        }
    } catch(e){
        console.error(e);
        alert('Error cargando perfil.');
    }
}

async function guardarCambios() {
    const token = getToken();
    if (!token) return window.location.href='login.html';

    const nombre = document.getElementById('input-nombre').value.trim();
    const correo = document.getElementById('input-correo').value.trim();
    const password = document.getElementById('input-password').value.trim();

    if(!nombre || !correo){ 
        document.getElementById('mensaje').textContent = 'Nombre y correo no pueden estar vacíos.'; 
        return; 
    }

    const payload = { nombre, correo };
    if(password) payload.password = password;

    try {
        const res = await fetch('/api/auth/update-profile', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': token },
            body: JSON.stringify(payload)
        });
        if(res.ok){
            document.getElementById('mensaje').style.color = 'green';
            document.getElementById('mensaje').textContent = 'Perfil actualizado exitosamente.';
            document.getElementById('input-password').value = '';
        } else {
            const data = await res.json();
            document.getElementById('mensaje').style.color = 'red';
            document.getElementById('mensaje').textContent = data.error || 'Error actualizando perfil.';
        }
    } catch(e){
        console.error(e);
        document.getElementById('mensaje').textContent = 'Error de conexión.';
    }
}

function cerrarSesion() {
    localStorage.removeItem('token');
    window.location.href='login.html';
}

document.addEventListener('DOMContentLoaded', ()=>{
    cargarPerfil();
    document.getElementById('btn-guardar').addEventListener('click', guardarCambios);
    document.getElementById('btn-cerrar-sesion').addEventListener('click', cerrarSesion);
});
</script>
</body>
</html>
